"use strict";"format global";"deps angular";angular.module("hyenaAngular",["ngStorage","firebase","ngTagsInput"]).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}),angular.module("hyenaAngular").controller("ApplicationCtrl",function($rootScope,$scope,$location,$window,$routeParams,$firebase,AuthService,UserService,AppFirebase,Notification,FBURL,AUTH_EVENTS,AUTH_SCOPE){$scope.appLoaded=null,$scope.currentUser=null,$rootScope.currentGroupId=0,AuthService.flow(AUTH_SCOPE).then(function(response){$scope.appLoaded=!0,$scope.currentUser=response},function(){console.error("There was an error logging in.")}),$scope.$watch("currentUser",function(newVal,oldVal){null===oldVal||!angular.isUndefined(newVal)&&null!==newVal?null!==oldVal&&Notification.hideModal():Notification.showModal("Please log in","#modal-content-login","takeover")}),$rootScope.$on(AUTH_EVENTS.notAuthenticated,function(){AuthService.expire(),$scope.currentUser=null,AuthService.login()}),AppFirebase.getAuthRef().$onAuth(function(authData){!authData&&$scope.appLoaded&&$rootScope.$broadcast(AUTH_EVENTS.notAuthenticated)}),$scope.setCurrentUser=function(user){$scope.currentUser=user},$scope.logOutCurrentUser=function(){$scope.currentUser=null,AuthService.logout()},$scope.logIn=function(){AuthService.check()||AuthService.login()},$scope.toggleMainDrawer=function(){document.querySelector("unl-layout").toggleDrawer()},$scope.closeMainDrawer=function(){document.querySelector("unl-layout").closeDrawer()},$scope.showLoginWindow=function(){Notification.setModalContent("#modal-content-login")},$scope.closeModal=function(){Notification.hideModal()},$scope.go=function(path,pageAnimationClass){$scope.pageAnimationClass="undefined"==typeof pageAnimationClass?"animate-slide-right":pageAnimationClass,"back"===path?($scope.pageAnimationClass="animate-slide-left",$window.history.back()):$location.path(path)}}),angular.module("hyenaAngular").directive("bindPolymer",function(){return{restrict:"A",link:function(scope,element,attrs){function watch(attr){scope.$watch(function(){return element.attr(attr)},function(value){for(var tokens=attrMap[attr].split(/\./),parent=scope,i=0;i<tokens.length-1;i++)"undefined"==typeof parent[tokens[i]]&&(parent[tokens[i]]={}),parent=parent[tokens[i]];parent[tokens[tokens.length-1]]=value})}var attrMap={};for(var prop in attrs.$attr)if("bindPolymer"!=prop){var _attr=attrs.$attr[prop],_match=element.attr(_attr).match(/\{\{\s*([\.\w]+)\s*\}\}/);_match&&(attrMap[_attr]=_match[1])}new MutationObserver(function(){scope.$apply()}).observe(element[0],{attributes:!0});for(var _attr in attrMap)watch(_attr)}}}),angular.module("hyenaAngular").value("FieldTypes",{text:["Text","should be text"],email:["Email","should be an email address"],number:["Number","should be a number"],date:["Date","should be a date"],datetime:["Datetime","should be a datetime"],time:["Time","should be a time"],month:["Month","should be a month"],week:["Week","should be a week"],url:["URL","should be a URL"],tel:["Phone Number","should be a phone number"],color:["Color","should be a color"]}).directive("selfValidation",function(FieldTypes){return{templateUrl:"views/partials/self-validation-input.html",restrict:"EA",replace:!0,scope:{model:"=",field:"@",type:"@",required:"@",placeholder:"@"},link:function($scope){$scope.types=FieldTypes}}}),angular.module("hyenaAngular").directive("user",function(UserService){return{restrict:"A",scope:{userValue:"=userModel"},link:function(scope){scope.userValue;scope.$watch("userValue",function(newValue){angular.isDefined(newValue)&&!angular.isObject(newValue)&&UserService.get(newValue).then(function(response){scope.userValue=response.data})})}}}),angular.module("hyenaAngular").factory("AppFirebase",function(FBURL,$firebase,$firebaseAuth){var appFirebase=new Firebase(FBURL),FirebaseService={getRef:function(){return appFirebase},getAuthRef:function(){return $firebaseAuth(appFirebase)},authenticate:function(authToken){var authRef=$firebaseAuth(appFirebase);return authRef.$authWithCustomToken(authToken)}};return FirebaseService}),angular.module("hyenaAngular").filter("uni_year",function(){return function(input){switch(input){case"FR":return"Freshman";case"SO":return"Sophomore";case"JR":return"Junior";case"SR":return"Senior";case"GR":return"Graduate";default:return"N/A"}}}).filter("toArray",function(){return function(obj){return obj instanceof Object?Object.keys(obj).map(function(key){return Object.defineProperty(obj[key],"$key",{enumerable:!1,value:key})}):obj}}),angular.module("hyenaAngular").service("AuthService",function($http,$sessionStorage,$localStorage,$location,$q,UserService,APIKEY,APIPATH,AppFirebase){var firebaseAuthRef=AppFirebase.getRef(),AuthService={flow:function(scope){scope=scope||"";var deferred=$q.defer();if(angular.isDefined($location.search().token)){var authToken=$location.search().token;$location.url($location.path());{AppFirebase.authenticate(authToken).then(function(authData){AuthService.manualLogin(authData.uid,authToken,scope).then(function(user){deferred.resolve(user.data),$scope.currentUser=user.data},function(error){deferred.reject(error),console.log("Login failed:",error)})},function(error){deferred.reject(error),console.error("Login failed:",error)})}}else AuthService.check()&&null!==AppFirebase.getAuthRef().$getAuth()?AuthService.user(scope).then(function(user){deferred.resolve(user.data)}):AuthService.login();return deferred.promise},login:function(){$sessionStorage.currentRoute=window.location.href,window.location.replace(APIPATH+"users/login?api_key="+APIKEY+"&callback="+window.location.href)},manualLogin:function(userId,authToken,scope){angular.isUndefined(scope)&&(scope="");var auth_user=UserService.get(userId,scope);return auth_user.then(function(){return AuthService.createAuthSession(userId,authToken)?AuthService.user(scope):!1})},logout:function(){AuthService.expire(),window.location.replace(APIPATH+"users/logout?api_key="+APIKEY)},createAuthSession:function(userId,authToken){return $localStorage.auth=!0,$localStorage.authUser=userId,$localStorage.authToken=authToken,!0},user:function(scope){angular.isUndefined(scope)&&(scope="");var userId=AuthService.userId();return UserService.get(userId,scope)},userId:function(){return $localStorage.auth?$localStorage.authUser:!1},authToken:function(){return $localStorage.authToken},check:function(){return!!$localStorage.auth},expire:function(){angular.isDefined(firebaseAuthRef)&&firebaseAuthRef.unauth(),delete $localStorage.auth,delete $localStorage.authUser,delete $localStorage.authToken}};return AuthService}),angular.module("hyenaAngular").factory("AuthInterceptor",function($rootScope,$q,AUTH_EVENTS){return{responseError:function(response){return $rootScope.$broadcast({401:AUTH_EVENTS.notAuthenticated,403:AUTH_EVENTS.notAuthorized,419:AUTH_EVENTS.sessionTimeout,440:AUTH_EVENTS.sessionTimeout}[response.status],response),$q.reject(response)}}}),angular.module("hyenaAngular").service("Notification",function(){var NotificationService={show:function(text,type){var toast=document.querySelector("unl-toast");toast.setAttribute("text",text),toast.setAttribute("type",type),toast.show()},showModal:function(heading,content,type){var modal=document.querySelector("#unl-modal"),newContent=document.querySelector(content);modal.setAttribute("heading",heading),modal.setAttribute("type",type||"lift"),modal.contents=newContent,modal.show()},hideModal:function(){var modal=document.querySelector("#unl-modal");modal.close()},setModalContent:function(content){var modal=document.querySelector("#unl-modal"),newContent=document.querySelector(content);modal.contents=newContent}};return NotificationService}),angular.module("hyenaAngular").service("UserService",function(APIPATH,APIKEY,$http,toArrayFilter){return{get:function(userId,scope){return angular.isUndefined(scope)&&(scope=""),$http.get(APIPATH+"users/"+userId+"?with="+scope+"&api_key="+APIKEY)},validate:function(user){return $http.post(APIPATH+"users/validate?api_key="+APIKEY,{ids:[user]})},getUserRelations:function(array,key){if(angular.isUndefined(array))return!1;key=key||"user",array=toArrayFilter(array);for(var userIdsArray=[],userIdsString="",i=0;i<array.length;i++)userIdsArray.push(array[i][key]),userIdsString+=array[i][key]+",";userIdsString=userIdsString.substring(0,userIdsString.length-1);var usersResponse=$http.get(APIPATH+"users?ids="+userIdsString+"&api_key="+APIKEY);return usersResponse.then(function(response){for(var i=0;i<response.data.length;i++)array[i][key]=response.data[i]}),array}}});